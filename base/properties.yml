---
meta:
  vault: (( concat "secret/" params.vault ))

instance_groups:
- name: shield
  instances: 1
  azs: [(( grab params.availability_zone ))]
  persistent_disk_pool: (( grab params.shield_disk_pool ))
  vm_type:              (( grab params.shield_vm_type   ))
  stemcell: default
  networks:
    - name: (( grab params.shield_network ))
      static_ips: 
      - (( grab params.shield_static_ip ))
  jobs:
  - name: shield-agent
    release: shield
    consumes:
      shield: {from: shield}
    properties:
      core:
        ca: (( vault meta.vault "/certs/ca:certificate" ))

  - name: core
    release: shield
    provides:
      shield: 
        shared: true
        as: shield
    properties:
      require-shield-core: true
      domain: (( grab params.shield_static_ip ))
      agent:
        key: (( vault meta.vault "/agent:private" ))
      tls:
        certificate: (( vault meta.vault "/certs/server:certificate" ))
        key:         (( vault meta.vault "/certs/server:key" ))
      vault:
        tls:
          ca:          (( vault meta.vault "/vault/ca:certificate" ))
          certificate: (( vault meta.vault "/vault/server:certificate" ))
          key:         (( vault meta.vault "/vault/server:key" ))
      core:
        env: (( grab params.installation ))

update:
  canaries: 0
  max_in_flight: 1
  serial: true
  canary_watch_time: 1000-120000
  update_watch_time: 1000-120000

stemcells:
- alias:   default
  os:      (( grab params.stemcell_os      || "ubuntu-trusty" ))
  version: (( grab params.stemcell_version || "latest" ))

releases:
- name: shield
  version: (( param "The pipeline seems to have broken" ))
